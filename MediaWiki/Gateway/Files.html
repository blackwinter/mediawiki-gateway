<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module MediaWiki::Gateway::Files - mediawiki-gateway Application documentation (v0.6.2)</title>

<link href="../../fonts.css" rel="stylesheet">
<link href="../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/navigation.js"></script>
<script src="../../js/search_index.js"></script>
<script src="../../js/search.js"></script>
<script src="../../js/searcher.js"></script>
<script src="../../js/darkfish.js"></script>


<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-download">#download</a>
    
    <li ><a href="#method-i-image_info">#image_info</a>
    
    <li ><a href="#method-i-images">#images</a>
    
    <li ><a href="#method-i-upload">#upload</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-MediaWiki::Gateway::Files">
  <h1 id="module-MediaWiki::Gateway::Files" class="module">
    module MediaWiki::Gateway::Files
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-download" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">download</span><span
            class="method-args">(file_name, options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Download <em>file_name</em> (without “File:” or “Image:” prefix). Returns
file contents. All options are passed to <a
href="Files.html#method-i-image_info">image_info</a> however <a
href="'iiprop'">options</a> is forced to url. You can still set other
options to control what file you want to download.</p>
          
          

          
          <div class="method-source-code" id="download-source">
            <pre><span class="ruby-comment"># File lib/media_wiki/gateway/files.rb, line 161</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">download</span>(<span class="ruby-identifier">file_name</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">attributes</span> = <span class="ruby-identifier">image_info</span>(<span class="ruby-identifier">file_name</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-string">&#39;iiprop&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;url&#39;</span>))
    <span class="ruby-constant">RestClient</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">attributes</span>[<span class="ruby-string">&#39;url&#39;</span>])
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-image_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">image_info</span><span
            class="method-args">(file_name_or_page_id, options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Requests image info from MediaWiki. Follows redirects.</p>

<p><em>file_name_or_page_id</em> should be either:</p>
<ul><li>
<p>a file name (String) you want info about without File: prefix.</p>
</li><li>
<p>or a Fixnum page id you of the file.</p>
</li></ul>

<p><em>options</em> is <code>Hash</code> passed as query arguments. See <a
href="http://www.mediawiki.org/wiki/API:Query_-_Properties#imageinfo_.2F_ii">www.mediawiki.org/wiki/API:Query_-_Properties#imageinfo_.2F_ii</a>
for more information.</p>

<p><a href="'iiprop'">options</a> should be either a string of properties
joined by &#39;|&#39; or an <code>Array</code> (or more precisely something
that responds to join).</p>

<p><code>Hash</code> like object is returned where keys are image properties.</p>

<p>Example:</p>

<pre class="ruby"><span class="ruby-identifier">mw</span>.<span class="ruby-identifier">image_info</span>(
  <span class="ruby-string">&#39;Trooper.jpg&#39;</span>, <span class="ruby-string">&#39;iiprop&#39;</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-string">&#39;timestamp&#39;</span>, <span class="ruby-string">&#39;user&#39;</span>]
).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{key.inspect} =&gt; #{value.inspect}&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Output:</p>

<pre class="ruby"><span class="ruby-string">&quot;timestamp&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;2009-10-31T12:59:11Z&quot;</span>
<span class="ruby-string">&quot;user&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;Valdas&quot;</span>
</pre>
          
          

          
          <div class="method-source-code" id="image_info-source">
            <pre><span class="ruby-comment"># File lib/media_wiki/gateway/files.rb, line 131</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">image_info</span>(<span class="ruby-identifier">file_name_or_page_id</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;iiprop&#39;</span>].<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:join</span>)
    <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;iiprop&#39;</span>] = <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;iiprop&#39;</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;|&#39;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">form_data</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>(
    <span class="ruby-string">&#39;action&#39;</span>    =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;query&#39;</span>,
    <span class="ruby-string">&#39;prop&#39;</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;imageinfo&#39;</span>,
    <span class="ruby-string">&#39;redirects&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>
  )

  <span class="ruby-identifier">file_name_or_page_id</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fixnum</span>) <span class="ruby-operator">?</span>
    <span class="ruby-identifier">form_data</span>[<span class="ruby-string">&#39;pageids&#39;</span>] = <span class="ruby-identifier">file_name_or_page_id</span> <span class="ruby-operator">:</span>
    <span class="ruby-identifier">form_data</span>[<span class="ruby-string">&#39;titles&#39;</span>]  = <span class="ruby-node">&quot;File:#{file_name_or_page_id}&quot;</span>

  <span class="ruby-identifier">xml</span> = <span class="ruby-identifier">make_api_request</span>(<span class="ruby-identifier">form_data</span>).<span class="ruby-identifier">first</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">valid_page?</span>(<span class="ruby-identifier">page</span> = <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-string">&#39;query/pages/page&#39;</span>])
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-string">&#39;query/redirects/r&#39;</span>]
      <span class="ruby-comment"># We&#39;re dealing with redirect here.</span>
      <span class="ruby-identifier">image_info</span>(<span class="ruby-identifier">page</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-string">&#39;pageid&#39;</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">options</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">page</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-string">&#39;imageinfo/ii&#39;</span>].<span class="ruby-identifier">attributes</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-images" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">images</span><span
            class="method-args">(article_or_pageid, imlimit = 200, options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Get image list for given <a href="s">article</a>.  Follows redirects.</p>

<p><em>article_or_pageid</em> is the title or pageid of a single article
<em>imlimit</em> is the maximum number of images to return (defaults to
200) <em>options</em> is the hash of additional options</p>

<p>Example:</p>

<pre>images = mw.images(&#39;Gaborone&#39;)</pre>

<p><em>images</em> would contain [&#39;File:Gaborone at night.jpg&#39;,
&#39;File:Gaborone2.png&#39;, …]</p>
          
          

          
          <div class="method-source-code" id="images-source">
            <pre><span class="ruby-comment"># File lib/media_wiki/gateway/files.rb, line 82</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">images</span>(<span class="ruby-identifier">article_or_pageid</span>, <span class="ruby-identifier">imlimit</span> = <span class="ruby-value">200</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-identifier">form_data</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>(
    <span class="ruby-string">&#39;action&#39;</span>    =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;query&#39;</span>,
    <span class="ruby-string">&#39;prop&#39;</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;images&#39;</span>,
    <span class="ruby-string">&#39;imlimit&#39;</span>   =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">imlimit</span>,
    <span class="ruby-string">&#39;redirects&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>
  )

  <span class="ruby-identifier">form_data</span>[<span class="ruby-identifier">article_or_pageid</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fixnum</span>) <span class="ruby-operator">?</span>
    <span class="ruby-string">&#39;pageids&#39;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&#39;titles&#39;</span>] = <span class="ruby-identifier">article_or_pageid</span>

  <span class="ruby-identifier">xml</span> = <span class="ruby-identifier">make_api_request</span>(<span class="ruby-identifier">form_data</span>).<span class="ruby-identifier">first</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">valid_page?</span>(<span class="ruby-identifier">page</span> = <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-string">&#39;query/pages/page&#39;</span>])
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-string">&#39;query/redirects/r&#39;</span>]
      <span class="ruby-comment"># We&#39;re dealing with redirect here.</span>
      <span class="ruby-identifier">images</span>(<span class="ruby-identifier">page</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-string">&#39;pageid&#39;</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">imlimit</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">REXML</span><span class="ruby-operator">::</span><span class="ruby-constant">XPath</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">page</span>, <span class="ruby-string">&#39;images/im&#39;</span>).<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-string">&#39;title&#39;</span>] }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-upload" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">upload</span><span
            class="method-args">(path, options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Upload a file, or get the status of pending uploads. Several methods are
available:</p>
<ul><li>
<p>Upload file contents directly.</p>
</li><li>
<p>Have the MediaWiki server fetch a file from a URL, using the &#39;url&#39;
parameter</p>
</li></ul>

<p>Requires Mediawiki 1.16+</p>

<p>Arguments:</p>
<ul><li><dl class="rdoc-list label-list"><dt>path
<dd>
<p>Path to file to upload. Set to nil if uploading from URL.</p>
</dd></dl>
</li><li><dl class="rdoc-list label-list"><dt>options
<dd>
<p>Hash of additional options</p>
</dd></dl>
</li></ul>

<p>Note that queries using session keys must be done in the same login session
as the query that originally returned the key (i.e. do not log out and then
log back in).</p>

<p>Options:</p>
<ul><li>
<p>&#39;filename&#39;       - Target filename (defaults to local name if not
given), <a href=":target">options</a> is alias for this.</p>
</li><li>
<p>&#39;comment&#39;        - Upload comment. Also used as the initial page
text for new files if &#39;text&#39; is not specified.</p>
</li><li>
<p>&#39;text&#39;           - Initial page text for new files</p>
</li><li>
<p>&#39;watch&#39;          - Watch the page</p>
</li><li>
<p>&#39;ignorewarnings&#39; - Ignore any warnings</p>
</li><li>
<p>&#39;url&#39;            - Url to fetch the file from. Set path to nil if
you want to use this.</p>
</li></ul>

<p>Deprecated but still supported options:</p>
<ul><li>
<p>:description     - Description of this file. Used as &#39;text&#39;.</p>
</li><li>
<p>:target          - Target filename, same as &#39;filename&#39;.</p>
</li><li>
<p>:summary         - Edit summary for history. Used as &#39;comment&#39;.
Also used as &#39;text&#39; if neither it or :description is specified.</p>
</li></ul>

<p>Examples:</p>

<pre class="ruby"><span class="ruby-identifier">mw</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-string">&#39;/path/to/local/file.jpg&#39;</span>, <span class="ruby-string">&#39;filename&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;RemoteFile.jpg&#39;</span>)
<span class="ruby-identifier">mw</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-keyword">nil</span>, <span class="ruby-string">&#39;filename&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;RemoteFile2.jpg&#39;</span>, <span class="ruby-string">&#39;url&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;http://remote.com/server/file.jpg&#39;</span>)
</pre>
          
          

          
          <div class="method-source-code" id="upload-source">
            <pre><span class="ruby-comment"># File lib/media_wiki/gateway/files.rb, line 41</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">upload</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:description</span>]
    <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;text&#39;</span>] = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:description</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:target</span>]
    <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;filename&#39;</span>] = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:target</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:summary</span>]
    <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;text&#39;</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:summary</span>]
    <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;comment&#39;</span>] = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:summary</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;comment&#39;</span>] <span class="ruby-operator">||=</span> <span class="ruby-string">&#39;Uploaded by MediaWiki::Gateway&#39;</span>

  <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;file&#39;</span>] = <span class="ruby-constant">File</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">path</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">path</span>

  <span class="ruby-identifier">full_name</span> = <span class="ruby-identifier">path</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;url&#39;</span>]
  <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;filename&#39;</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">full_name</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">full_name</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;file&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;url&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;sessionkey&#39;</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>,
      <span class="ruby-string">&quot;One of the &#39;file&#39;, &#39;url&#39; or &#39;sessionkey&#39; options must be specified!&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">make_api_request</span>(<span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>(
    <span class="ruby-string">&#39;action&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;upload&#39;</span>,
    <span class="ruby-string">&#39;token&#39;</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">get_token</span>(<span class="ruby-string">&#39;edit&#39;</span>, <span class="ruby-identifier">options</span>[<span class="ruby-string">&#39;filename&#39;</span>])
  ))
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

